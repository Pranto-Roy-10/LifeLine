{% extends "base.html" %} {% block title %}Log in – LifeLine{% endblock %} {%
block content %}

<section class="w-full px-6 md:px-12 py-10 md:py-16 flex justify-center page-transition">
  <div
    class="w-full max-w-md rounded-3xl border border-emerald-500/20 bg-gradient-to-br from-slate-900/80 to-slate-950/90 p-6 md:p-8 shadow-2xl backdrop-filter backdrop-blur-xl card-hover"
  >
    <h2 class="text-xl md:text-2xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-emerald-300 to-cyan-300">Log in to LifeLine</h2>
    <p class="text-xs text-slate-400 mb-6 animate-fadeInUp">
      Access your neighborhood map, help requests, and kindness dashboard.
    </p>

    {# FLASH MESSAGES #} {% with messages =
    get_flashed_messages(with_categories=true) %} {% if messages %}
    <div class="mb-4 space-y-2 text-xs">
      {% for category, msg in messages %}
      <div
        class="rounded-xl px-3 py-2 {% if category == 'error' %}bg-rose-500/10 text-rose-200 border border-rose-500/40 {% elif category == 'success' %}bg-emerald-500/10 text-emerald-200 border border-emerald-500/40 {% else %}bg-slate-800 text-slate-200 border border-slate-600/60{% endif %}"
      >
        {{ msg }}
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %} {# ---------------- PASSWORD LOGIN
    ---------------- #}
    <div class="space-y-4 mb-6">
      <h3 class="text-sm font-semibold text-slate-200">Log in with password</h3>

      <form method="post" action="{{ url_for('login') }}" class="space-y-4">
        <div>
          <label class="block text-xs text-slate-300 mb-2 font-medium">Email</label>
          <input
            type="email"
            name="email"
            required
            class="form-input w-full"
            placeholder="you@example.com"
          />
        </div>

        <div>
          <label class="block text-xs text-slate-300 mb-2 font-medium">Password</label>
          <input
            type="password"
            name="password"
            required
            class="form-input w-full"
            placeholder="••••••••"
          />
        </div>

        <button
          type="submit"
          class="w-full rounded-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-slate-950 text-sm font-bold py-2.5 mt-3 transition duration-300 transform hover:scale-105 active:scale-95 shadow-lg hover:shadow-emerald-500/40"
        >
          Log in
        </button>
      </form>
    </div>

    {# ---------------- GOOGLE LOGIN ---------------- #}
    <div class="mt-2 mb-4">
      <button
        id="google-login-btn"
        type="button"
        class="w-full rounded-full border border-slate-700 bg-white/5 hover:bg-white/10 text-sm font-semibold py-2.5 flex items-center justify-center gap-2 transition"
      >
        <img
          src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
          alt="Google"
          class="h-4 w-4"
        />
        <span>Continue with Google</span>
      </button>
    </div>

    {# SEPARATOR #}
    <div class="flex items-center my-5">
      <div class="flex-1 h-px bg-gradient-to-r from-slate-800 to-transparent"></div>
      <span class="px-3 text-[10px] uppercase tracking-widest text-slate-500 font-semibold">
        or
      </span>
      <div class="flex-1 h-px bg-gradient-to-l from-slate-800 to-transparent"></div>
    </div>

    {# ---------------- OTP LOGIN ---------------- #}
    <div class="space-y-3">
      <h3 class="text-sm font-semibold text-slate-200">
        Log in with one-time code (OTP)
      </h3>
      <p class="text-[11px] text-slate-400">
        Use this if you don’t remember your password or are logging in from a
        shared device. The OTP is sent to your email.
      </p>

      {# STEP 1: REQUEST OTP #}
      <form
        id="otp-request-form"
        method="post"
        action="{{ url_for('login_otp_request') }}"
        class="space-y-2"
      >
        <div>
          <label class="block text-xs text-slate-300 mb-1">Email for OTP</label>
          <input
            type="email"
            name="email"
            class="w-full rounded-xl bg-slate-950 border border-slate-700 focus:border-sky-400 focus:outline-none text-sm px-3 py-2"
            placeholder="you@example.com"
            required
          />
        </div>

        <button
          id="otp-send-btn"
          type="submit"
          class="w-full rounded-full border border-sky-400/70 text-sky-300 hover:bg-sky-500/10 text-xs font-semibold py-2 transition"
        >
          Send OTP
        </button>
        <p
          id="otp-countdown"
          class="text-[11px] text-slate-400 mt-1 h-4 flex items-center"
        ></p>
      </form>

      {# STEP 2: VERIFY OTP #}
      <form
        method="post"
        action="{{ url_for('login_otp_verify') }}"
        class="space-y-2 mt-3"
      >
        <div>
          <label class="block text-xs text-slate-300 mb-1"
            >Email (same as above)</label
          >
          <input
            type="email"
            name="email"
            class="w-full rounded-xl bg-slate-950 border border-slate-700 focus:border-emerald-400 focus:outline-none text-sm px-3 py-2"
            placeholder="you@example.com"
            required
          />
        </div>

        <div>
          <label class="block text-xs text-slate-300 mb-1">OTP code</label>
          <input
            type="text"
            name="otp"
            class="w-full rounded-xl bg-slate-950 border border-slate-700 focus:border-emerald-400 focus:outline-none text-sm px-3 py-2"
            placeholder="6-digit code"
            required
          />
        </div>

        <button
          type="submit"
          class="w-full rounded-full bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-semibold py-2 transition"
        >
          Log in with OTP
        </button>
      </form>
    </div>

    <p class="text-xs text-slate-400 mt-6">
      New here?
      <a
        href="{{ url_for('signup') }}"
        class="text-emerald-300 hover:text-emerald-200"
      >
        Create a LifeLine account
      </a>
    </p>
  </div>
</section>

{# ---------------- SCRIPTS: GOOGLE + OTP COOLDOWN ---------------- #}
<script type="module">
  /* ----------------- Firebase Google Login ----------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBXr5LOHnwm4T9mg3epZmpTnY924F3-4J0",
    authDomain: "lifeline-4ebf0.firebaseapp.com",
    projectId: "lifeline-4ebf0",
    storageBucket: "lifeline-4ebf0.firebasestorage.app",
    messagingSenderId: "624241564606",
    appId: "1:624241564606:web:4672a35b5b7ca6c413f7ef",
    measurementId: "G-1WTCBY1P9L",
  };

  const fbApp = initializeApp(firebaseConfig);
  const auth = getAuth(fbApp);
  const provider = new GoogleAuthProvider();

  const googleBtn = document.getElementById("google-login-btn");

  if (googleBtn) {
    googleBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      googleBtn.disabled = true;
      const originalText = googleBtn.innerText;
      googleBtn.innerText = "Connecting...";

      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        const idToken = await user.getIdToken();

        const resp = await fetch("{{ url_for('auth_google') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken }),
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          alert(data.error || "Google login failed.");
          return;
        }

        window.location.href = data.redirect_url || "{{ url_for('home') }}";
      } catch (err) {
        console.error("Google sign-in error:", err);
        alert("Google login cancelled or failed.");
      } finally {
        googleBtn.disabled = false;
        googleBtn.innerText = originalText;
      }
    });
  }

  /* ----------------- OTP cooldown logic ----------------- */
  const otpSendBtn = document.getElementById("otp-send-btn");
  const otpCountdownSpan = document.getElementById("otp-countdown");
  const COOLDOWN_SECONDS = 30;
  const STORAGE_KEY = "lifeline_otp_last_request";

  function startOtpCooldown() {
    if (!otpSendBtn || !otpCountdownSpan) return;

    const lastTs = Number(localStorage.getItem(STORAGE_KEY) || "0");
    const now = Date.now();
    let remaining = COOLDOWN_SECONDS - Math.floor((now - lastTs) / 1000);

    if (remaining <= 0) {
      otpSendBtn.disabled = false;
      otpCountdownSpan.textContent = "";
      return;
    }

    otpSendBtn.disabled = true;
    otpCountdownSpan.textContent = `Try again in ${remaining}s`;

    const interval = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        clearInterval(interval);
        otpSendBtn.disabled = false;
        otpCountdownSpan.textContent = "";
      } else {
        otpCountdownSpan.textContent = `Try again in ${remaining}s`;
      }
    }, 1000);
  }

  if (otpSendBtn && otpCountdownSpan) {
    startOtpCooldown();
  }

  const otpForm = document.getElementById("otp-request-form");
  if (otpForm && otpSendBtn && otpCountdownSpan) {
    otpForm.addEventListener("submit", () => {
      localStorage.setItem(STORAGE_KEY, String(Date.now()));
      startOtpCooldown();
    });
  }
</script>

{% endblock %}
