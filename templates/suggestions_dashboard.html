{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Smart Suggestions Widget -->
            {% include 'smart_suggestions_widget.html' %}
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- User Stats -->
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-100 mb-4">üèÜ Your Profile</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-slate-400">Trust Score</p>
                        <p class="text-2xl font-bold text-indigo-300" id="trust-score">--</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Kindness Score</p>
                        <p class="text-2xl font-bold text-emerald-300" id="kindness-score">--</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Badge</p>
                        <p class="text-lg font-bold text-amber-300" id="user-badge">--</p>
                    </div>
                </div>
            </div>
            
            <!-- Trending Categories -->
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-slate-100 mb-4">üî• Trending Help Needed</h3>
                <div id="trending-categories" class="space-y-2">
                    <p class="text-slate-400 text-sm">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    
    // Load trending categories
    function loadTrendingCategories() {
        fetch('/api/trending-categories?hours=24&limit=5')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('trending-categories');
            container.innerHTML = '';
            
            if (data.trending_categories && data.trending_categories.length > 0) {
                data.trending_categories.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between px-3 py-2 rounded-xl border border-slate-800 bg-slate-900/50 border-l-4 border-indigo-500/40';
                    div.innerHTML = `
                        <span class="font-semibold text-slate-100 capitalize">${escapeHtml(item.category)}</span>
                        <span class="text-[11px] font-semibold px-2.5 py-1 rounded-full border bg-indigo-500/10 text-indigo-200 border-indigo-400/30">${item.count}</span>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p class="text-slate-400 text-sm">No trending categories yet.</p>';
            }
        })
        .catch(error => {
            console.error('Error loading trending categories:', error);
        });
    }
    
    // Load user insights
    function loadUserInsights() {
        fetch('/api/suggestion-insights')
        .then(async (response) => {
            // Suggestion insights may be 401 if not logged in
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`HTTP ${response.status}: ${text.slice(0, 120)}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.insights) {
                const insights = data.insights.user_score;
                document.getElementById('trust-score').textContent = insights.trust_score || 0;
                document.getElementById('kindness-score').textContent = insights.kindness_score || 0;
                document.getElementById('user-badge').textContent = insights.badge || 'Newbie';
            }
        })
        .catch(error => {
            console.error('Error loading user insights:', error);
            // Keep UI stable even if user isn't logged in or has no location
            const trustEl = document.getElementById('trust-score');
            const kindEl = document.getElementById('kindness-score');
            const badgeEl = document.getElementById('user-badge');
            if (trustEl) trustEl.textContent = '--';
            if (kindEl) kindEl.textContent = '--';
            if (badgeEl) badgeEl.textContent = '--';
        });
    }
    
    function getUrgencyColor(urgency) {
        const u = (urgency || 'normal').toLowerCase();
        if (u === 'emergency') return 'bg-rose-500/10 text-rose-200 border border-rose-400/30';
        if (u === 'high') return 'bg-amber-500/10 text-amber-200 border border-amber-400/30';
        return 'bg-sky-500/10 text-sky-200 border border-sky-400/30';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load on page init
    document.addEventListener('DOMContentLoaded', () => {
        loadTrendingCategories();
        loadUserInsights();
    });
</script>
{% endblock %}
