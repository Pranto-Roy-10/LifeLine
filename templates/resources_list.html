{% extends 'base.html' %}

{% block title %}Share Items - LifeLine{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto py-8 px-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-semibold">Neighborhood Resources</h2>
    <div class="flex gap-3">
      <a href="{{ url_for('resources.create_resource') }}" class="px-4 py-2 rounded bg-emerald-500 text-slate-900 font-medium hover:bg-emerald-600">Share an Item</a>
      <a href="{{ url_for('resources.search_resource') }}" class="px-4 py-2 rounded bg-sky-500 text-slate-900 font-medium hover:bg-sky-600">Request an Item</a>
      {% if session.get('user_id') %}
      <a href="{{ url_for('resources.my_requests') }}" class="px-4 py-2 rounded bg-purple-600 text-white font-medium hover:bg-purple-700">My Requests</a>
      {% endif %}
    </div>
  </div>

  <!-- Request Item Info Banner -->
  <div id="request-item-info" class="mb-6 p-4 rounded-xl bg-sky-500/10 border border-sky-500/30">
    <p class="text-sm text-sky-300">
      <span class="font-semibold">How to request an item:</span> Simply click "Request Item" on any available item below, write a message to the owner, and they will review your request. Once accepted, you can chat with them to arrange pickup.
    </p>
  </div>

  <!-- Neighbors are looking for section -->
  <div class="mb-6 p-4 rounded-xl bg-slate-800 border border-slate-700">
    <div class="mb-4">
      <div class="mb-3 text-sm font-semibold text-slate-200">Neighbors are looking for:</div>
      
      <!-- Search/Filter for wanted requests -->
      <form method="get" class="flex flex-wrap items-center gap-3 mb-4">
        <input 
          type="text" 
          name="search_wanted" 
          placeholder="Search what neighbors want..." 
          value="{{ search_wanted or '' }}" 
          class="flex-1 min-w-40 bg-slate-700 border border-slate-600 px-3 py-2 rounded text-sm text-white placeholder-slate-400"
        />
        <select name="wanted_category" class="bg-slate-700 border border-slate-600 px-3 py-2 rounded text-sm text-white">
          <option value="">All categories</option>
          {% for c in wanted_categories %}
          <option value="{{ c }}" {% if wanted_cat == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="px-4 py-2 rounded bg-slate-600 text-white text-sm font-medium hover:bg-slate-500">Search</button>
        {% if search_wanted or wanted_cat %}
        <a href="{{ url_for('resources.list_resources') }}" class="px-4 py-2 rounded bg-slate-600 text-white text-sm font-medium hover:bg-slate-500">Clear</a>
        {% endif %}
      </form>
    </div>

    {% if wanted_requests %}
    <div class="space-y-3">
      {% for req, days_left in wanted_requests %}
      <div class="p-4 rounded-lg bg-slate-700 border border-slate-600">
        <div class="flex items-start gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <div class="text-base font-semibold text-slate-100">{{ req.title }}</div>
              {% if days_left is not none %}
                {% if days_left <= 3 %}
                  <span class="px-2 py-1 rounded text-xs font-semibold bg-red-900 text-red-200">{{ days_left }} day{{ 's' if days_left != 1 else '' }} left</span>
                {% elif days_left <= 7 %}
                  <span class="px-2 py-1 rounded text-xs font-semibold bg-amber-900 text-amber-200">{{ days_left }} days left</span>
                {% else %}
                  <span class="px-2 py-1 rounded text-xs font-semibold bg-slate-600 text-slate-200">{{ days_left }} days left</span>
                {% endif %}
              {% endif %}
            </div>
            <div class="text-xs text-slate-400">{{ req.category }}</div>
            {% if req.description %}
            <p class="mt-2 text-sm text-slate-300">{{ req.description }}</p>
            {% endif %}
            {% if req.contact_info %}
            <div class="mt-1 text-xs text-slate-400">Contact: {{ req.contact_info }}</div>
            {% endif %}
          </div>
          <div class="text-right text-xs text-slate-400 flex items-start justify-between gap-2">
            <div>
              {{ req.user.name if req.user else 'Unknown' }}<br>
              {% if req.created_at %}
                {{ req.created_at.strftime('%b %d, %Y') }}
              {% endif %}
            </div>
            {% if current_user and current_user.id == req.user_id %}
            <form method="post" action="{{ url_for('resources.delete_wanted_item', wanted_id=req.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this wanted item?');">
              <button type="submit" class="text-slate-400 hover:text-red-400 transition flex-shrink-0" title="Delete wanted item">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        <div class="mt-3 flex items-center gap-2">
          {% if req.image_url %}
          <button onclick="openImagePreview('{{ req.image_url }}', '{{ req.title }}')" class="px-3 py-1 rounded bg-slate-600 text-white text-xs font-medium hover:bg-slate-500">View Picture</button>
          {% endif %}
          {% if req.user and current_user and current_user.id != req.user_id %}
          <a href="{{ url_for('chat_with_user', other_user_id=req.user.id) }}" class="px-3 py-1 rounded bg-purple-600 text-white text-xs font-medium hover:bg-purple-700">Chat with requester</a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-sm text-slate-400">No neighbors are looking for items matching your search.</div>
    {% endif %}
  </div>

  <div class="mb-4">
    <form method="get" class="flex items-center gap-3">
      <select name="category" class="bg-slate-800 border border-slate-700 px-3 py-2 rounded">
        <option value="">All categories</option>
        {% for c in categories %}
        <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      <button class="px-3 py-2 rounded bg-slate-700">Filter</button>
    </form>
  </div>

  {% if items %}
  <div class="grid grid-cols-1 gap-4">
    {% for it in items %}
    <div class="p-4 rounded-xl bg-slate-800 border border-slate-700">
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold">{{ it.title }}</h3>
              <div class="text-sm text-slate-400">{{ it.category }} Â· {{ it.quantity or 'Quantity not specified' }}</div>
            </div>
            <div class="text-xs text-slate-400">Shared by {{ it.user.name if it.user else 'Unknown' }}</div>
          </div>

          {% if it.description %}
          <p class="mt-2 text-sm text-slate-300">{{ it.description }}</p>
          {% endif %}

          <div class="mt-3 flex items-center gap-3">
            {% if current_user and current_user.id == it.user_id %}
              <!-- Owner can mark as claimed -->
              <form action="{{ url_for('resources.claim_resource', resource_id=it.id) }}" method="post">
                <button class="px-3 py-1 rounded bg-emerald-500 text-slate-900 font-medium">Mark Claimed</button>
              </form>
              {% if it.image_url %}
              <button onclick="openImagePreview('{{ it.image_url }}', '{{ it.title }}')" class="px-3 py-1 rounded bg-slate-600 text-white text-xs font-medium hover:bg-slate-500">View Picture</button>
              {% endif %}
              <a href="{{ url_for('resources.my_items') }}" class="text-xs text-sky-300 underline">View Requests</a>
            {% else %}
              <!-- Other users can request -->
              {% set status = user_request_status.get(it.id) if user_request_status else None %}
              {% if status %}
                <span class="px-2 py-1 rounded text-xs font-semibold
                  {% if status == 'accepted' %} bg-green-900 text-green-200
                  {% elif status == 'rejected' %} bg-red-900 text-red-200
                  {% else %} bg-amber-900 text-amber-200 {% endif %}">
                  {{ status|capitalize }}
                </span>
              {% endif %}
              {% if not status or status == 'rejected' %}
                <a href="{{ url_for('resources.request_resource', resource_id=it.id) }}" class="px-3 py-1 rounded bg-sky-500 text-slate-900 font-medium">Request Item</a>
              {% endif %}
              {% if it.image_url %}
              <button onclick="openImagePreview('{{ it.image_url }}', '{{ it.title }}')" class="px-3 py-1 rounded bg-slate-600 text-white text-xs font-medium hover:bg-slate-500">View Picture</button>
              {% endif %}
              {% if it.contact_info %}
              <div class="text-sm text-slate-400">Contact: {{ it.contact_info }}</div>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="p-6 rounded-xl bg-slate-800 border border-slate-700">No shared resources yet. Be the first to share an item.</div>
  {% endif %}
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50" onclick="closeImagePreview()">
  <div class="relative bg-slate-900 rounded-lg p-4 max-w-2xl max-h-96" onclick="event.stopPropagation()">
    <button onclick="closeImagePreview()" class="absolute top-2 right-2 text-slate-400 hover:text-white">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <img id="previewImage" src="" alt="" class="max-w-full max-h-96 rounded">
    <p id="previewTitle" class="text-center text-white mt-3 text-sm"></p>
  </div>
</div>

<script>
function openImagePreview(imageUrl, title) {
  document.getElementById('previewImage').src = imageUrl;
  document.getElementById('previewTitle').textContent = title;
  document.getElementById('imagePreviewModal').classList.remove('hidden');
}

function closeImagePreview() {
  document.getElementById('imagePreviewModal').classList.add('hidden');
}
</script>

{% endblock %}
