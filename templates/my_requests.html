{% extends 'base.html' %}

{% block title %}My Requests - LifeLine{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto py-8 px-6">
  <h2 class="text-2xl font-semibold mb-6">My Item Requests</h2>

  {% if not requests %}
  <div class="text-center py-12 text-slate-400">
    <p>You haven't made any requests yet.</p>
    <a href="{{ url_for('resources.list_resources') }}" class="inline-block mt-4 px-4 py-2 rounded bg-sky-500 text-slate-900 font-medium">Browse Items</a>
  </div>
  {% else %}
    <div class="space-y-4">
      {% for req in requests %}
      <div class="p-4 rounded-xl bg-slate-800 border border-slate-700">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-start gap-4">
              {% if req.resource.image_url %}
              <img src="{{ req.resource.image_url }}" alt="{{ req.resource.title }}" class="w-20 h-20 rounded object-cover">
              {% endif %}
              <div class="flex-1">
                <h3 class="text-lg font-semibold">{{ req.resource.title }}</h3>
                <div class="text-sm text-slate-400">{{ req.resource.category }} Â· {{ req.resource.quantity or 'Quantity not specified' }}</div>
                <div class="mt-1 text-xs text-slate-300">Shared by: <span class="font-medium">{{ req.resource.user.name if req.resource.user else 'Unknown' }}</span></div>
                
                {% if req.message %}
                <div class="mt-3 p-3 rounded bg-slate-900 border-l-2 border-sky-500">
                  <p class="text-sm text-slate-300">{{ req.message }}</p>
                </div>
                {% endif %}

                <div class="mt-2 text-xs text-slate-500">
                  Requested: {{ req.created_at.strftime('%b %d, %Y at %I:%M %p') if req.created_at else 'Date unknown' }}
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col gap-2 items-end">
            <!-- Status badge -->
            {% if req.status == 'pending' %}
            <span class="px-3 py-1 rounded text-xs font-semibold bg-amber-900 text-amber-200">Pending</span>
            {% elif req.status == 'accepted' %}
            <span class="px-3 py-1 rounded text-xs font-semibold bg-green-900 text-green-200">Accepted</span>
            {% elif req.status == 'rejected' %}
            <span class="px-3 py-1 rounded text-xs font-semibold bg-red-900 text-red-200">Rejected</span>
            {% endif %}

            <!-- Action buttons -->
            <div class="flex gap-2 items-center">
              {% if req.status == 'accepted' and req.resource.user %}
              <a href="{{ url_for('chat_with_user', other_user_id=req.resource.user.id) }}" class="px-3 py-1 rounded bg-purple-600 text-white text-xs font-medium hover:bg-purple-700">Chat</a>
              {% endif %}
              
              <form method="post" action="{{ url_for('resources.delete_request', request_id=req.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this request?');">
                <button type="submit" class="text-slate-400 hover:text-red-400 transition" title="Delete request">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- My Wanted Items Section -->
  <div class="mt-12">
    <h2 class="text-2xl font-semibold mb-6">My Wanted Items</h2>
    
    {% if not wanted_items %}
    <div class="text-center py-12 text-slate-400">
      <p>You haven't posted any wanted items yet.</p>
      <a href="{{ url_for('resources.list_resources') }}" class="inline-block mt-4 px-4 py-2 rounded bg-sky-500 text-slate-900 font-medium">Request an Item</a>
    </div>
    {% else %}
      <div class="space-y-4">
        {% for entry in wanted_items %}
        <div class="p-4 rounded-xl bg-slate-800 border border-slate-700">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="text-lg font-semibold">{{ entry.item.title }}</h3>
                <span class="px-2 py-1 rounded text-xs font-semibold bg-slate-700 text-slate-300">{{ entry.item.category }}</span>
                
                {% if entry.item.status == 'open' %}
                  {% if entry.days_left is not none %}
                    {% if entry.days_left <= 3 %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-red-900 text-red-200">Expires in {{ entry.days_left }} day(s)</span>
                    {% elif entry.days_left <= 7 %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-amber-900 text-amber-200">Expires in {{ entry.days_left }} days</span>
                    {% else %}
                    <span class="px-2 py-1 rounded text-xs font-semibold bg-emerald-900 text-emerald-200">Expires in {{ entry.days_left }} days</span>
                    {% endif %}
                  {% endif %}
                {% else %}
                <span class="px-2 py-1 rounded text-xs font-semibold bg-slate-600 text-slate-400">Closed</span>
                {% endif %}
              </div>
              
              {% if entry.item.description %}
              <p class="text-sm text-slate-400 mb-2">{{ entry.item.description }}</p>
              {% endif %}

              <div class="text-xs text-slate-500">
                Posted: {{ entry.item.created_at.strftime('%b %d, %Y at %I:%M %p') if entry.item.created_at else 'Date unknown' }}
              </div>
            </div>

            <div class="flex gap-2 items-center">
              {% if entry.item.image_url %}
              <button onclick="openImagePreview('{{ entry.item.image_url }}', '{{ entry.item.title }}')" class="px-3 py-2 rounded bg-slate-600 text-white text-sm font-medium hover:bg-slate-500">View Picture</button>
              {% endif %}
              
              <form method="post" action="{{ url_for('resources.delete_wanted_item', wanted_id=entry.item.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this wanted item?');">
                <button type="submit" class="text-slate-400 hover:text-red-400 transition" title="Delete wanted item">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50" onclick="closeImagePreview()">
  <div class="relative max-w-4xl max-h-screen p-4">
    <button onclick="closeImagePreview()" class="absolute top-6 right-6 text-white text-3xl font-bold hover:text-gray-300">&times;</button>
    <img id="previewImage" src="" alt="" class="max-w-full max-h-screen rounded-lg">
  </div>
</div>

<script>
  function openImagePreview(imageUrl, title) {
    const modal = document.getElementById('imagePreviewModal');
    const img = document.getElementById('previewImage');
    img.src = imageUrl;
    img.alt = title;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeImagePreview() {
    const modal = document.getElementById('imagePreviewModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
</script>
{% endblock %}
