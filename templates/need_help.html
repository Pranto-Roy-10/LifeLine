{% extends "base.html" %} {% block title %}I Need Help{% endblock %} {% block
content %}
<div class="w-full max-w-7xl mx-auto px-6 py-10 page-transition">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 items-start">
    <!-- üü© FORM CARD -->
    <div
      class="lg:col-span-2 bg-gradient-to-br from-slate-900/80 to-slate-950/90 backdrop-blur-md border border-emerald-500/20 rounded-2xl p-8 shadow-xl card-hover hover:border-emerald-400/40"
    >
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-emerald-300 to-cyan-300 bg-clip-text text-transparent">I Need Help</h2>
          <p class="text-xs text-slate-400 mt-1">
            Tell your neighbors what you need. Keep it short but clear.
          </p>
        </div>
        {% if current_user %}
        <div class="text-[11px] text-slate-400 text-right">
          <p>Posting as</p>
          <p class="font-semibold text-emerald-300">{{ current_user.name }}</p>
        </div>
        {% else %}
        <div class="text-[11px] text-slate-400 text-right">
          <p>Posting as</p>
          <p class="font-semibold text-emerald-300">Guest (quick help)</p>
        </div>
        {% endif %}
      </div>

      <!-- FORM -->
      <form id="need-help-form" method="POST" class="space-y-6">
        <!-- TITLE + CATEGORY -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-300"
              >Title <span class="text-emerald-400">*</span></label
            >
            <input
              name="title"
              required
              maxlength="120"
              placeholder="Need medicine from pharmacy"
              class="form-input w-full mt-1"
            />
          </div>

          <div>
            <label class="text-xs text-slate-300"
              >Category <span class="text-emerald-400">*</span></label
            >
            <select
              name="category"
              required
              class="form-input w-full mt-1"
            >
              <option value="" disabled selected>Select a category</option>
              <option value="medicine">Medicine</option>
              <option value="food">Food</option>
              <option value="tutoring">Tutoring</option>
              <option value="repair">Repair</option>
              <option value="ride">Ride</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <!-- LOCATION INFO -->
        <div>
          <p class="text-xs text-slate-300 mb-2">Where are you?</p>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-[11px] text-slate-400"
                >Area / Neighborhood</label
              >
              <input
                name="area"
                placeholder="Badda, near BRACU"
                class="w-full mt-1 px-4 py-2.5 rounded-xl bg-slate-950/80 text-white border border-emerald-500/20 focus:border-emerald-400/40 focus:outline-none text-sm transition"
              />
            </div>
            <div>
              <label class="text-[11px] text-slate-400">Nearest landmark</label>
              <input
                name="landmark"
                placeholder="Near mosque / school / BRACU campus"
                class="w-full mt-1 px-4 py-2.5 rounded-xl bg-slate-950/80 text-white border border-emerald-500/20 focus:border-emerald-400/40 focus:outline-none text-sm transition"
              />
            </div>
          </div>
        </div>

        <!-- üîπ MAP PICKER + HIDDEN LAT/LNG (REQUIRED) -->
        <input type="hidden" name="lat" id="help-lat" />
        <input type="hidden" name="lng" id="help-lng" />

        <div class="mt-2">
          <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-slate-300">
              Pin your exact location on map
              <span class="text-emerald-400">*</span>
            </p>
            <button
              type="button"
              onclick="useMyLocationForHelp()"
              class="text-[11px] px-3 py-1 rounded-full border border-emerald-400/60 text-emerald-300 hover:bg-emerald-500/10 transition"
            >
              Use my current location
            </button>
          </div>
          <div
            id="help-map"
            class="w-full h-56 rounded-2xl border border-emerald-500/20 overflow-hidden shadow-lg"
          ></div>
          <p class="text-[10px] text-slate-500 mt-1">
            Click anywhere on the map to drop a pin. You must pin a location to
            post.
          </p>
        </div>

        <!-- URGENCY + TIME WINDOW -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-300">How urgent is this?</label>
            <div class="mt-2 flex flex-wrap gap-2 text-[11px]">
              {% for level,label in [ ('low','Low'), ('normal','Normal'),
              ('high','High'), ('emergency','Emergency') ] %}
              <label
                class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-950/80 border border-emerald-500/20 cursor-pointer hover:border-emerald-400 transition"
              >
                <input type="radio" name="urgency" value="{{ level }}"
                class="h-3 w-3" {% if level == 'normal' %}checked{% endif %}>
                <span class="capitalize text-slate-300">{{ label }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <div>
            <label class="text-xs text-slate-300">When do you need help?</label>
            <select
              name="time_window"
              class="w-full mt-2 px-4 py-2.5 rounded-xl bg-slate-950/80 text-white border border-emerald-500/20 focus:border-emerald-400/40 focus:outline-none text-sm transition"
            >
              <option value="anytime_today">Anytime today</option>
              <option value="next_few_hours">Within the next few hours</option>
              <option value="this_week">Sometime this week</option>
              <option value="specific_time">
                I will mention in description
              </option>
            </select>
          </div>
        </div>

        <!-- CONTACT PREFERENCE -->
        <div>
          <p class="text-xs text-slate-300 mb-2">
            How can helpers contact you?
          </p>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-[11px] text-slate-400"
                >Preferred contact method</label
              >
              <select
                name="contact_method"
                class="w-full mt-1 px-4 py-2.5 rounded-xl bg-slate-950/80 text-white border border-emerald-500/20 focus:border-emerald-400/40 focus:outline-none text-sm transition"
              >
                <option value="lifeline_chat">LifeLine chat only</option>
                <option value="phone">Phone call</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="sms">SMS</option>
              </select>
            </div>

            <div>
              <label class="text-[11px] text-slate-400"
                >Phone / WhatsApp (digits only)</label
              >
              <input
                name="contact_info"
                type="tel"
                inputmode="numeric"
                pattern="\d{7,15}"
                maxlength="15"
                placeholder="01XXXXXXXXX"
                class="w-full mt-1 px-4 py-2.5 rounded-xl bg-slate-950/80 text-white border border-emerald-500/20 focus:border-emerald-400/40 focus:outline-none text-sm transition"
              />
              <p class="text-[10px] text-slate-500 mt-1">
                Required if you choose phone / WhatsApp / SMS.
              </p>
            </div>
          </div>
        </div>

        <!-- DESCRIPTION -->
        <div>
          <label class="text-xs text-slate-300">Describe what you need</label>
          <textarea
            name="description"
            rows="5"
            required
            minlength="10"
            placeholder="Example: My father is sick, I need someone to pick up BP medicine from the nearby pharmacy before 9 PM..."
            class="form-input w-full mt-1"
          ></textarea>
        </div>

        <!-- EXPIRY -->
        <div class="flex flex-wrap items-center gap-3">
          <div>
            <label class="text-xs text-slate-300">Expires in (minutes)</label>
            <input
              type="number"
              name="expiry_minutes"
              value="60"
              min="15"
              max="1440"
              class="mt-1 w-32 px-4 py-2.5 rounded-xl bg-slate-950/80 text-white border border-emerald-500/20 focus:border-emerald-400/40 focus:outline-none text-sm transition"
            />
          </div>
          <p class="text-[11px] text-slate-400">
            After this time, your request will disappear from the active feed.
          </p>
        </div>

        <!-- SUBMIT -->
        <div class="pt-2">
          <button
            class="bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-600 hover:to-cyan-600 text-slate-950 font-semibold px-6 py-3 rounded-xl text-sm transition hover:scale-105 w-full"
          >
            Post Need
          </button>
        </div>
      </form>
    </div>

    <!-- üü¶ SIDEBAR (unchanged) -->
    <div class="space-y-8 lg:sticky lg:top-24 self-start">
      {{ super() }}

      <!-- Recent Need Help posts -->
      <div
        class="bg-slate-800/60 backdrop-blur-md border border-slate-700 rounded-2xl p-5"
      >
        <h3 class="text-sm font-semibold text-slate-200 mb-3">
          People who need help
        </h3>

        <div
          class="space-y-3 lg:max-h-[calc(100vh-10rem)] lg:overflow-y-auto lg:pr-1"
        >
          {% for post in posts %} {% set is_sos = ((post.category or '')|lower
          == 'sos') %}
          <div class="rounded-2xl border border-slate-700 bg-slate-900/40 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-slate-100 truncate">
                  {{ post.title }}
                </div>
                <div class="mt-0.5 text-[11px] text-slate-400">
                  {{ post.created_at.strftime("%Y-%m-%d %H:%M") if
                  post.created_at else "" }}
                </div>
              </div>
              <button
                type="button"
                class="shrink-0 text-slate-400 hover:text-slate-200 transition"
                aria-expanded="false"
                aria-controls="sidebar-details-{{ post.id }}"
                onclick="toggleNeedHelpSidebarDetails('{{ post.id }}', this)"
                title="Expand"
              >
                <span
                  id="sidebar-icon-{{ post.id }}"
                  class="inline-block transition-transform duration-150"
                >
                  ‚ñº
                </span>
              </button>
            </div>

            <div class="mt-2 flex flex-wrap items-center gap-2 text-[11px]">
              <span
                class="px-2 py-1 rounded-full border border-slate-600 text-slate-200 bg-slate-800/80"
              >
                {{ (post.category or 'Other')|capitalize }}
              </span>

              {% if is_sos %}
              <span
                class="px-2 py-1 rounded-full bg-rose-500/10 text-rose-300 border border-rose-500/40 font-bold"
              >
                üö® SOS
              </span>
              {% endif %} {% if post.is_offer %}
              <span
                class="px-2 py-1 rounded-full bg-sky-500/10 text-sky-300 border border-sky-500/40"
              >
                Offer help
              </span>
              {% else %}
              <span
                class="px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40"
              >
                Needs help
              </span>
              {% endif %} {% if current_user and post.user_id == current_user.id
              %}
              <span
                class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-300 border border-indigo-500/40 font-bold"
              >
                My Post
              </span>
              {% endif %}
            </div>

            {% if not is_sos %} {% set flag = flagged_map.get(post.id) if
            flagged_map is defined and flagged_map else None %} {% set reasons =
            (flag.get('reasons') if flag is mapping else '') | default('', true)
            %} {% set reasons_l = reasons|lower %} {% set is_duplicate =
            ('possible duplicate' in reasons_l) or ('duplicate of request' in
            reasons_l) or ('flagged duplicate' in reasons_l) %} {% set is_scam =
            ('scam-like keywords' in reasons_l) or ('contains scam' in
            reasons_l) %} {% if flag and (is_scam or is_duplicate) %} {% if
            is_scam and is_duplicate %}
            <div
              class="mt-2 p-3 rounded-xl border border-sky-400/60 bg-sky-500/10"
            >
              <p class="text-sky-200 text-sm font-semibold">
                Potential scam + duplicate flagged by LifeLine AI
              </p>
              <p class="text-sky-200/80 text-xs mt-0.5">
                recommended: Verify before offering help
              </p>
            </div>
            {% elif is_duplicate %}
            <div
              class="mt-2 p-3 rounded-xl border border-purple-400/60 bg-purple-500/10"
            >
              <p class="text-purple-200 text-sm font-semibold">
                Possible duplicate scanned by LifeLine AI
              </p>
            </div>
            {% elif is_scam %}
            <div
              class="mt-3 p-3 rounded-xl border border-amber-400/60 bg-amber-500/10"
            >
              <p class="text-amber-200 text-sm font-semibold">
                Possible scam detected by LifeLine AI
              </p>
              <p class="text-amber-200/80 text-xs mt-0.5">
                recommended: Verify before offering help
              </p>
            </div>
            {% endif %} {% endif %} {% endif %}

            <div class="mt-2 text-[12px] text-slate-300 line-clamp-2">
              {{ post.description }}
            </div>

            <div
              id="sidebar-details-{{ post.id }}"
              class="hidden mt-3 border-t border-slate-800 pt-3 space-y-2 text-xs text-slate-200"
            >
              <p class="text-[12px] text-slate-300 whitespace-pre-line">
                {{ post.description or "No details provided." }}
              </p>

              {% if post.landmark %}
              <p class="text-[11px] text-slate-400">
                <span class="font-semibold">Landmark:</span> {{ post.landmark }}
              </p>
              {% endif %} {% if post.time_window %}
              <p class="text-[11px] text-slate-400">
                <span class="font-semibold">When:</span> {{ post.time_window }}
              </p>
              {% endif %} {% if post.contact_method %}
              <p class="text-[11px] text-slate-400">
                <span class="font-semibold">Contact via:</span> {{
                post.contact_method }}
              </p>
              {% endif %} {% if is_sos and current_user and post.user_id ==
              current_user.id %}
              <div
                class="mt-2 rounded-xl border border-slate-700 bg-slate-900/40 p-3"
              >
                <p class="text-[11px] text-slate-200 font-bold mb-2">
                  SOS responders
                </p>
                {% if post.sos_responses and post.sos_responses|length > 0 %}
                <div class="space-y-2">
                  {% for resp in post.sos_responses %}
                  <div
                    class="rounded-lg border border-slate-700 bg-slate-950/60 p-2"
                  >
                    <div class="flex items-center justify-between gap-2">
                      <div class="flex items-center gap-2 min-w-0">
                        <div
                          class="w-6 h-6 rounded-full bg-slate-700 overflow-hidden"
                        >
                          <img
                            src="{{ (resp.helper.profile_photo if resp.helper and resp.helper.profile_photo else url_for('static', filename='images/lifeline_logo.png')) }}"
                            class="w-full h-full object-cover"
                          />
                        </div>
                        <span
                          class="text-[12px] font-semibold text-slate-200 truncate"
                          >{{ resp.helper.name if resp.helper else ('User #' ~
                          resp.helper_id) }}</span
                        >
                      </div>
                      <a
                        href="{{ url_for('chat_with_user', other_user_id=resp.helper_id) }}"
                        class="text-[11px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-700"
                      >
                        Chat
                      </a>
                    </div>

                    <form
                      action="{{ url_for('complete_sos', request_id=post.id, helper_id=resp.helper_id) }}"
                      method="POST"
                      class="mt-2 space-y-2"
                    >
                      <div class="flex gap-1">
                        {% for i in range(1, 6) %}
                        <label class="cursor-pointer">
                          <input type="radio" name="rating" value="{{ i }}"
                          class="sr-only peer" {% if i==5 %}checked{% endif %}>
                          <span
                            class="text-slate-600 peer-checked:text-yellow-400 text-base hover:text-yellow-300 transition"
                            >‚òÖ</span
                          >
                        </label>
                        {% endfor %}
                      </div>
                      <div>
                        <label class="block text-[10px] text-slate-400 mb-1"
                          >Duration (Hours)</label
                        >
                        <input
                          type="number"
                          name="hours"
                          step="0.5"
                          min="0.5"
                          value="1"
                          class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-[11px] text-white focus:outline-none focus:border-emerald-500"
                        />
                      </div>
                      <textarea
                        name="comment"
                        rows="2"
                        placeholder="How did they help?"
                        class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-[11px] focus:outline-none focus:border-emerald-500"
                      ></textarea>
                      <button
                        type="submit"
                        class="w-full bg-emerald-600 hover:bg-emerald-500 text-white text-[11px] font-bold py-2 rounded"
                      >
                        Mark SOS Complete & Review
                      </button>
                    </form>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <p class="text-[11px] text-slate-500">
                  Waiting for responders‚Ä¶
                </p>
                {% endif %}
              </div>
              {% endif %}
            </div>

            <div class="mt-2 text-[11px] text-slate-400">
              <span class="text-rose-400">üìç</span>
              {{ post.area or "Unknown" }}
              <span class="text-slate-500">‚Ä¢</span>
              Urgency:
              <span
                class="{% if post.urgency == 'emergency' %}text-rose-400 {% elif post.urgency == 'high' %}text-amber-300 {% elif post.urgency == 'normal' %}text-sky-300 {% else %}text-emerald-300{% endif %}"
              >
                {{ (post.urgency or 'normal')|capitalize }}
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <script>
      function toggleNeedHelpSidebarDetails(id, btnEl) {
        const details = document.getElementById(`sidebar-details-${id}`);
        const icon = document.getElementById(`sidebar-icon-${id}`);
        if (!details) return;

        const willOpen = details.classList.contains("hidden");
        details.classList.toggle("hidden");

        if (icon) {
          icon.classList.toggle("rotate-180", willOpen);
        }

        if (btnEl) {
          btnEl.setAttribute("aria-expanded", willOpen ? "true" : "false");
          btnEl.title = willOpen ? "Collapse" : "Expand";
        }
      }

      let helpMap, helpMarker;

      function initHelpMap() {
        const defaultPos = { lat: 23.7806, lng: 90.425 };

        helpMap = new google.maps.Map(document.getElementById("help-map"), {
          center: defaultPos,
          zoom: 15,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
        });

        helpMap.addListener("click", (e) => {
          setHelpMarker(e.latLng);
        });
      }

      function setHelpMarker(latLng) {
        if (helpMarker) {
          helpMarker.setMap(null);
        }
        helpMarker = new google.maps.Marker({
          position: latLng,
          map: helpMap,
        });

        document.getElementById("help-lat").value = latLng.lat().toFixed(6);
        document.getElementById("help-lng").value = latLng.lng().toFixed(6);
      }

      function useMyLocationForHelp() {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const p = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
            };
            helpMap.setCenter(p);
            helpMap.setZoom(17);
            setHelpMarker(p);
          },
          () => {
            alert("Could not get your location.");
          }
        );
      }

      // ‚úÖ block submit if map location not set
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("need-help-form");
        form.addEventListener("submit", (e) => {
          const lat = document.getElementById("help-lat").value;
          const lng = document.getElementById("help-lng").value;
          if (!lat || !lng) {
            e.preventDefault();
            alert("Please pin your location on the map before posting.");
          }
        });
      });
    </script>

    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initHelpMap"
    ></script>
  </div>
</div>

{% endblock %}
