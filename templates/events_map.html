{% extends "base.html" %} {% block title %}Events Map – LifeLine{% endblock %}
{% block content %}
<section class="w-full px-6 md:px-12 py-8 md:py-10 space-y-4">
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between gap-3"
  >
    <div>
      <h2 class="text-xl md:text-2xl font-semibold mb-1">Events map</h2>
      <p class="text-sm text-slate-400 max-w-2xl">
        Browse community events on the map. Click a marker to see details.
      </p>
    </div>

    <div class="flex gap-2">
      <a
        href="{{ url_for('list_events') }}"
        class="px-4 py-2 rounded-full bg-slate-900 border border-slate-700 text-xs text-slate-200 hover:border-emerald-400 hover:text-emerald-300 transition"
        >Back to list</a
      >
      <a
        href="{{ url_for('create_event') }}"
        class="px-4 py-2 rounded-full bg-emerald-500 text-slate-950 text-xs font-semibold hover:bg-emerald-400 transition"
        >Create event</a
      >
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-4 lg:gap-6">
    <div class="lg:col-span-2 relative">
      <div
        id="events-map"
        class="w-full rounded-3xl border border-slate-800 bg-slate-900"
        style="height: 520px"
      ></div>
    </div>

    <div
      class="flex flex-col rounded-3xl border border-slate-800 bg-slate-900/80 backdrop-blur p-4 shadow-xl max-h-[520px] overflow-auto"
    >
      <h3 class="text-sm font-semibold text-slate-100 mb-3">Events</h3>
      {% if events and events|length > 0 %}
      <div class="space-y-2">
        {% for e in events %}
        <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-3">
          <p class="text-sm font-semibold text-slate-100">{{ e.title }}</p>
          <p class="text-[11px] text-slate-400 mt-1">
            {{ e.area or 'Unknown area' }} • {{ e.date.strftime('%b %d, %Y') if
            e.date else '' }}
          </p>
          {% if e.description %}
          <p class="text-xs text-slate-300 mt-2">{{ e.description }}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-xs text-slate-500">No events to show.</p>
      {% endif %}
    </div>
  </div>
</section>

<script id="events-data" type="application/json">
  {{ (events_data or []) | tojson }}
</script>

<script>
  const eventsData = (() => {
    try {
      const el = document.getElementById("events-data");
      return JSON.parse(el ? el.textContent : "[]");
    } catch (e) {
      return [];
    }
  })();

  // Google Maps calls the callback by name on window.
  window.initEventsMap = function initEventsMap() {
    const fallbackCenter = { lat: 23.8103, lng: 90.4125 };

    const first = eventsData && eventsData.length ? eventsData[0] : null;

    const hasFirstCoords =
      first &&
      first.lat != null &&
      first.lng != null &&
      !Number.isNaN(Number(first.lat)) &&
      !Number.isNaN(Number(first.lng));

    const center = hasFirstCoords
      ? { lat: Number(first.lat), lng: Number(first.lng) }
      : fallbackCenter;

    const map = new google.maps.Map(document.getElementById("events-map"), {
      center,
      zoom: 12,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });

    const info = new google.maps.InfoWindow();

    (eventsData || []).forEach((e) => {
      if (e.lat == null || e.lng == null) return;
      const lat = Number(e.lat);
      const lng = Number(e.lng);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return;
      const marker = new google.maps.Marker({
        position: { lat, lng },
        map,
        title: e.title || "Event",
      });

      marker.addListener("click", () => {
        const html = `
          <div style="max-width:240px">
            <div style="font-weight:600;margin-bottom:4px">${
              e.title || "Event"
            }</div>
            <div style="font-size:12px;opacity:.85">${e.area || ""}</div>
            <div style="font-size:12px;opacity:.85">${
              e.event_type ? String(e.event_type).replace("_", " ") : ""
            }</div>
          </div>`;
        info.setContent(html);
        info.open({ anchor: marker, map });
      });
    });
  };
</script>

{% if google_maps_key %}
<script
  async
  defer
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initEventsMap"
></script>
{% else %}
<div class="px-6 md:px-12 pb-8">
  <div
    class="rounded-2xl border border-rose-500/30 bg-rose-500/10 text-rose-200 text-sm p-4"
  >
    Google Maps key is missing. Set the environment variable
    <strong>GOOGLE_MAPS_API_KEY</strong> and restart the app.
  </div>
</div>
{% endif %} {% endblock %}
