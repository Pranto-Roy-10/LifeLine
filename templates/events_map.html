{% extends "base.html" %}
{% block content %}

<div class="max-w-6xl mx-auto px-6 py-8">
  <h1 class="text-3xl font-bold text-white mb-6">
    Community Events Map
  </h1>

  <div id="map" class="w-full h-[500px] rounded-xl border border-gray-700"></div>
</div>

<script>
const events = [
  {% for e in events %}
  {
    title: "{{ e.title|escape }}",
    description: "{{ e.description|escape }}",
    lat: {{ e.lat }},
    lng: {{ e.lng }},
    date: "{{ e.date.strftime('%B %d, %Y') }}",
    area: "{{ e.area|escape }}",
    created: "{{ e.created_at.strftime('%B %d, %Y') if e.created_at else '' }}",
    completed: "{% if e.completed %}{{ (e.completed_at or e.date).strftime('%B %d, %Y') if (e.completed_at or e.date) else '' }}{% else %}{% endif %}",
    isCompleted: {{ 'true' if e.completed else 'false' }}
  },
  {% endfor %}
];

function initMap() {
  const center = { lat: 23.8103, lng: 90.4125 }; // Dhaka
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 12,
    center: center,
    styles: [
      { elementType: "geometry", stylers: [{ color: "#0f172a" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#e5e7eb" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#0f172a" }] }
    ]
  });

  events.forEach(e => {
    const marker = new google.maps.Marker({
      position: { lat: e.lat, lng: e.lng },
      map: map,
      title: e.title
    });

    const info = new google.maps.InfoWindow({
      content: `
        <div style="color:black">
          <strong>${e.title}</strong><br>
          ${e.description}<br>
          ğŸ“ ${e.area}<br>
          ğŸ“… ${e.date}<br>
          â±ï¸ ${e.created ? e.created : 'Date unknown'} â†’ ${e.isCompleted ? (e.completed || e.date) : 'In progress'}
        </div>
      `
    });

    marker.addListener("click", () => info.open(map, marker));
  });
}
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap"
  async defer>
</script>

{% endblock %}
