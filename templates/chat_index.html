{% extends 'base.html' %}
{% block content %}
<div class="chat-index-fullpage page-transition">
  <div class="chat-index-container">
    <div class="chat-index-header border-b border-emerald-500/20">
      <div class="header-title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="message-icon">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <h2 class="bg-gradient-to-r from-emerald-300 to-cyan-300 bg-clip-text text-transparent">Messages</h2>
      </div>
      <div class="header-actions">
        <div class="search-container">
          <input type="text" id="search-input" class="search-input" placeholder="Search conversations...">
          <button class="icon-btn search-btn" id="search-btn" title="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="conversations-section">
      <h3 class="section-title bg-gradient-to-r from-emerald-300 to-cyan-300 bg-clip-text text-transparent">Recent Conversations</h3>
      {% if conversations %}
        <div class="conversations-grid">
          {% for item in conversations %}
          <div class="conversation-card card-hover border border-emerald-500/20 hover:border-emerald-400/40 bg-slate-950/80" data-conv-id="{{ item.conversation.id }}" data-other-id="{{ item.other.id }}">
            <a href="{{ url_for('chat_with_user', other_user_id=item.other.id) }}" class="conversation-link">
              <div class="conversation-avatar">
                {{ item.other.name[0].upper() }}
                {% if item.unread_count and item.unread_count > 0 %}
                <span class="unread-dot"></span>
                {% endif %}
              </div>
              <div class="conversation-content">
                <div class="conversation-header">
                  <h4 class="conversation-name">
                    {{ item.other.name }}
                    {% if item.unread_count and item.unread_count > 0 %}
                    <span class="unread-indicator-badge">{{ item.unread_count }}</span>
                    {% endif %}
                  </h4>
                </div>
                <div class="conversation-preview {% if item.unread_count and item.unread_count > 0 %}unread{% endif %}">
                  {{ item.last_message or 'No messages yet' }}
                </div>
              </div>
            </a>
            <form method="POST" action="{{ url_for('delete_conversation', conv_id=item.conversation.id) }}" class="delete-form" onsubmit="return confirm('Delete this conversation?')">
              <button type="submit" class="delete-btn" title="Delete conversation">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <p>No conversations yet</p>
          <span>Start a chat with a trusted helper below</span>
        </div>
      {% endif %}
    </div>

    <div class="helpers-section">
      <h3 class="section-title bg-gradient-to-r from-emerald-300 to-cyan-300 bg-clip-text text-transparent">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Trusted Helpers
      </h3>
      <div class="helpers-grid">
        {% for h in helpers %}
        <a href="{{ url_for('chat_with_user', other_user_id=h.id) }}" class="helper-card card-hover border border-emerald-500/20 hover:border-emerald-400/40 bg-slate-950/80">
          <div class="helper-avatar bg-gradient-to-br from-emerald-400 to-cyan-400 text-slate-950">{{ h.name[0].upper() }}</div>
          <div class="helper-info">
            <h4 class="text-white">{{ h.name }}</h4>
            <span class="helper-badge text-emerald-300">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Verified Helper
            </span>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  const CURRENT_USER_ID = {{ current_user.id if current_user else 'null' }};
  const CONVERSATION_IDS = {{ conversation_ids|tojson }};
</script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/chat_index.js') }}"></script>
{% endblock %}
