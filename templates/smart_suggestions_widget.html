<!-- Smart Suggestion AI Widget -->
<div id="smart-suggestions-widget" class="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ðŸ’¡</span>
            <h3 class="text-xl font-bold text-slate-100">AI Suggestions</h3>
            <span id="weather-source-badge" class="ml-3 text-[11px] px-2 py-1 rounded-full border hidden"></span>
        </div>
        <button id="refresh-suggestions" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
            Refresh
        </button>
    </div>
    
    <!-- Loading State -->
    <div id="suggestions-loading" class="text-center py-8">
        <div class="inline-block">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-400"></div>
        </div>
        <p class="text-slate-400 mt-2">Analyzing opportunities...</p>
    </div>
    
    <!-- Suggestions List -->
    <div id="suggestions-container" class="hidden space-y-3">
        <div id="no-suggestions" class="text-center py-6 text-slate-400 hidden">
            <p>No suggestions available at the moment. Check back soon!</p>
        </div>
    </div>
    
    <!-- Weather Info -->
    <div id="weather-info" class="hidden mt-4 pt-4 border-t border-gray-200">
        <div class="text-sm text-slate-400">
            <p id="weather-display" class="font-semibold"></p>
        </div>
    </div>
    
    <!-- Error Message -->
    <div id="suggestions-error" class="hidden bg-rose-500/10 border border-rose-500/30 text-rose-200 px-4 py-3 rounded-xl text-sm">
        <span id="error-message"></span>
    </div>
</div>

<script>
    // Smart Suggestions JS Module
    const SmartSuggestions = {
        isLoading: false,
        userLat: null,
        userLng: null,
        aiRendered: false,
        
        init: function() {
            // Prefer live geolocation; fall back to server defaults if unavailable
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        this.userLat = pos.coords.latitude;
                        this.userLng = pos.coords.longitude;
                        console.log('[SmartSuggestions] Using geolocation:', this.userLat, this.userLng);
                        this.loadSuggestions(this.userLat, this.userLng);
                    },
                    (err) => {
                        console.warn('[SmartSuggestions] Geolocation denied or failed:', err.message);
                        this.loadSuggestions(null, null);
                    },
                    { timeout: 5000, maximumAge: 60000 }
                );
            } else {
                console.log('[SmartSuggestions] Geolocation not available; using server fallback');
                this.loadSuggestions(null, null);
            }
            
            // Setup refresh button
            document.getElementById('refresh-suggestions').addEventListener('click', () => {
                this.loadSuggestions(this.userLat, this.userLng);
            });
        },
        
        loadSuggestions: function(lat, lng) {
            if (this.isLoading) return;
            this.isLoading = true;
            
            // Use provided coordinates or instance variables
            const latitude = lat !== undefined && lat !== null ? lat : this.userLat;
            const longitude = lng !== undefined && lng !== null ? lng : this.userLng;
            
            // Show loading state
            // Keep container visible to avoid flicker when permission prompts appear
            document.getElementById('suggestions-loading').classList.remove('hidden');
            document.getElementById('suggestions-container').classList.remove('hidden');
            document.getElementById('suggestions-error').classList.add('hidden');
            
            // Only include coordinates if both are valid
            const payload = { max_suggestions: 5 };
            if (latitude !== null && latitude !== undefined && 
                longitude !== null && longitude !== undefined) {
                payload.lat = latitude;
                payload.lng = longitude;
                console.log('[SmartSuggestions] Using coordinates:', latitude, longitude);
            } else {
                console.log('[SmartSuggestions] No coordinates - server will use defaults');
            }
            
            fetch('/api/suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('[SmartSuggestions] API Response status:', response.status);
                return response.json();
            })
            .then(data => {
                this.isLoading = false;
                console.log('[SmartSuggestions] Full API response:', JSON.stringify(data, null, 2));
                const suggestions = data && data.suggestions ? data.suggestions : [];
                console.log('[SmartSuggestions] Extracted', suggestions.length, 'AI suggestions');
                this.displaySuggestions(suggestions);
                if (data && data.error) {
                    console.warn('[SmartSuggestions] API warning:', data.error);
                }
            })
            .catch(error => {
                this.isLoading = false;
                console.error('[SmartSuggestions] Error loading suggestions:', error);
                this.displaySuggestions([]);
            });
            
            // Also load weather and insights
            this.loadWeather(latitude, longitude);
        },
        
        loadWeather: function(lat, lng) {
            // If location is missing, let backend choose fallback coordinates
            const weatherUrl = (lat === null || lat === undefined || lng === null || lng === undefined)
                ? '/api/weather'
                : `/api/weather?lat=${lat}&lng=${lng}`;
            
            fetch(weatherUrl, { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                const weather = data && data.weather ? data.weather : null;
                if (weather) this.displayWeather(weather);
                this.updateWeatherSourceBadge((data && data.source) ? data.source : 'unavailable', !!(data && data.success));
            })
            .catch(error => {
                console.error('Error loading weather:', error);
                this.updateWeatherSourceBadge('unavailable', false);
            });
        },
        
        displaySuggestions: function(suggestions) {
            console.log('[SmartSuggestions] displaySuggestions called with', suggestions ? suggestions.length : 0, 'items');
            console.log('[SmartSuggestions] Suggestions array:', JSON.stringify(suggestions, null, 2));
            
            document.getElementById('suggestions-loading').classList.add('hidden');
            document.getElementById('suggestions-container').classList.remove('hidden');
            document.getElementById('suggestions-error').classList.add('hidden');
            
            const container = document.getElementById('suggestions-container');
            const placeholder = document.getElementById('no-suggestions');

            // Keep placeholder in the DOM but clear only old cards
            if (placeholder && !container.contains(placeholder)) {
                container.appendChild(placeholder);
            }
            container.querySelectorAll('.suggestion-card').forEach(el => el.remove());
            
            if (!suggestions || suggestions.length === 0) {
                console.log('[SmartSuggestions] No AI suggestions, falling back to nearby');
                if (placeholder) placeholder.classList.remove('hidden');
                this.renderFromNearby();
                return;
            }

            console.log('[SmartSuggestions] Rendering', suggestions.length, 'AI suggestion cards');
            if (placeholder) placeholder.classList.add('hidden');
            this.aiRendered = true;
            
            suggestions.forEach((suggestion, index) => {
                console.log('[SmartSuggestions] Creating card', index + 1, 'for:', suggestion.title);
                const card = this.createSuggestionCard(suggestion);
                container.appendChild(card);
            });
        },
        
        createSuggestionCard: function(suggestion) {
            try {
                const card = document.createElement('div');
                card.className = 'rounded-2xl border border-slate-800 bg-slate-900/50 px-4 py-3 flex items-start justify-between gap-4 transition hover:border-indigo-400/40 hover:bg-slate-900/70';
                
                const urgencyClass = this.getUrgencyClass(suggestion.urgency);
                const scoreClass = this.getScoreClass(suggestion.relevance_score);
                
                console.log('[SmartSuggestions] Card details:', {
                    title: suggestion.title,
                    explanation: suggestion.explanation,
                    score: suggestion.relevance_score,
                    urgency: suggestion.urgency
                });
                
                const content = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center text-[10px] font-semibold px-2 py-1 rounded-full border ${urgencyClass}">
                                ${(suggestion.urgency || 'normal').toUpperCase()}
                            </span>
                            <span class="inline-flex items-center text-[10px] font-semibold px-2 py-1 rounded-full border bg-indigo-500/10 text-indigo-200 border-indigo-400/30">Suggested by AI</span>
                            <span class="text-[10px] text-slate-400">${suggestion.distance_km || 0}km away</span>
                        </div>
                        <h4 class="font-bold text-slate-100 mb-1">${this.escapeHtml(suggestion.title)}</h4>
                        <p class="text-sm text-slate-300 mb-2">${this.escapeHtml(suggestion.description || '')}</p>
                        <p class="text-xs text-indigo-200 font-semibold">AI: ${this.escapeHtml(suggestion.explanation || 'N/A')}</p>
                    </div>
                    <div class="ml-4 text-right">
                        <div class="text-sm font-bold px-3 py-2 rounded-xl border ${scoreClass}">
                            ${suggestion.relevance_score}%
                        </div>
                        <button class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-sm transition suggestion-action" data-request-id="${suggestion.id}">
                            Help Now
                        </button>
                    </div>
                `;
                
                card.innerHTML = content;
                
                // Add click handler to help button - submit offer via AJAX without redirect
                card.querySelector('.suggestion-action').addEventListener('click', () => {
                    const requestId = suggestion.id;
                    const btn = card.querySelector('.suggestion-action');
                    const originalText = btn.textContent;
                    
                    btn.disabled = true;
                    btn.textContent = 'Submitting...';
                    
                    fetch(`/requests/${requestId}/offer`, {
                        method: 'POST',
                        credentials: 'include'
                    })
                    .then(response => {
                        if (response.ok) {
                            btn.textContent = 'âœ“ Offer Sent!';
                            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                            btn.classList.add('bg-emerald-600');
                            setTimeout(() => {
                                btn.disabled = false;
                                btn.textContent = originalText;
                                btn.classList.remove('bg-emerald-600');
                                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                            }, 3000);
                        } else {
                            btn.textContent = 'Error';
                            btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                            btn.classList.add('bg-rose-600');
                            setTimeout(() => {
                                btn.disabled = false;
                                btn.textContent = originalText;
                                btn.classList.remove('bg-rose-600');
                                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting offer:', error);
                        btn.textContent = 'Error';
                        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        btn.classList.add('bg-rose-600');
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.textContent = originalText;
                            btn.classList.remove('bg-rose-600');
                            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                        }, 3000);
                    });
                });
                
                console.log('[SmartSuggestions] Card created successfully');
                return card;
            } catch (err) {
                console.error('[SmartSuggestions] Error creating card:', err, 'Suggestion:', suggestion);
                throw err;
            }
        },

        renderFromNearby: function() {
            const container = document.getElementById('suggestions-container');
            const placeholder = document.getElementById('no-suggestions');
            // Ensure container is visible when mirroring nearby requests
            container.classList.remove('hidden');
            if (placeholder && !container.contains(placeholder)) {
                container.appendChild(placeholder);
            }
            fetch('/api/nearby-requests?limit=5', { credentials: 'include' })
              .then(r => r.json())
              .then(n => {
                  const nearby = (n && n.requests) ? n.requests : [];
                  container.querySelectorAll('.suggestion-card').forEach(el => el.remove());
                  if (!nearby.length) {
                      if (placeholder) placeholder.classList.remove('hidden');
                      return;
                  }
                  if (placeholder) placeholder.classList.add('hidden');
                  console.log('[SmartSuggestions] Rendering', nearby.length, 'nearby requests as fallback');
                  nearby.forEach(req => {
                      const mapped = {
                          id: req.id,
                          title: req.title,
                          category: req.category,
                          description: req.description,
                          urgency: req.urgency,
                          distance_km: req.distance_km,
                          relevance_score: 52,
                          explanation: 'Nearby request shown as fallback'
                      };
                      const card = SmartSuggestions.createSuggestionCard(mapped);
                      container.appendChild(card);
                  });
              })
              .catch(() => {
                  document.getElementById('no-suggestions').classList.remove('hidden');
              });
        },
        
        displayWeather: function(weather) {
            const weatherInfo = document.getElementById('weather-info');
            const weatherDisplay = document.getElementById('weather-display');
            
            if (weather.condition) {
                const temp = weather.temp ? `${weather.temp}Â°C` : '';
                const condition = weather.condition || '';
                weatherDisplay.textContent = `ðŸŒ¤ï¸ ${condition} ${temp}`;
                weatherInfo.classList.remove('hidden');
            }
        },

        updateWeatherSourceBadge: function(source, success) {
            const badge = document.getElementById('weather-source-badge');
            if (!badge) return;

            // Reset classes
            badge.classList.remove(
                'hidden',
                'bg-emerald-500/10', 'text-emerald-200', 'border-emerald-400/30',
                'bg-amber-500/10', 'text-amber-200', 'border-amber-400/30',
                'bg-rose-500/10', 'text-rose-200', 'border-rose-400/30'
            );

            let text = '';
            let cls = ['bg-rose-500/10', 'text-rose-200', 'border-rose-400/30'];

            if (success && source === 'openweathermap') {
                text = 'Weather: Live OpenWeatherMap';
                cls = ['bg-emerald-500/10', 'text-emerald-200', 'border-emerald-400/30'];
            } else if (source === 'demo') {
                text = 'Weather: Demo fallback';
                cls = ['bg-amber-500/10', 'text-amber-200', 'border-amber-400/30'];
            } else {
                text = 'Weather: Unavailable';
                cls = ['bg-rose-500/10', 'text-rose-200', 'border-rose-400/30'];
            }

            badge.textContent = text;
            badge.classList.add(...cls);
            badge.classList.remove('hidden');
        },
        
        showError: function(message) {
            document.getElementById('suggestions-loading').classList.add('hidden');
            document.getElementById('suggestions-container').classList.add('hidden');
            document.getElementById('suggestions-error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        },
        
        getUrgencyClass: function(urgency) {
            const urgencyLower = (urgency || 'normal').toLowerCase();
            if (urgencyLower === 'emergency') return 'bg-rose-500/10 text-rose-200 border-rose-400/30';
            if (urgencyLower === 'high') return 'bg-amber-500/10 text-amber-200 border-amber-400/30';
            return 'bg-sky-500/10 text-sky-200 border-sky-400/30';
        },
        
        getScoreClass: function(score) {
            if (score >= 80) return 'bg-emerald-500/10 text-emerald-200 border-emerald-400/30';
            if (score >= 50) return 'bg-amber-500/10 text-amber-200 border-amber-400/30';
            return 'bg-slate-800/60 text-slate-200 border-slate-700';
        },
        
        escapeHtml: function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    };
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        SmartSuggestions.init();
    });
</script>
