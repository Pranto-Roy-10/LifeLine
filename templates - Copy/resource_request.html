{% extends 'base.html' %}

{% block title %}Request Item - LifeLine{% endblock %}

{% block content %}
<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
</style>
<div class="min-h-screen w-full bg-slate-950">
  <div class="bg-slate-950 border-b border-slate-800 shadow-lg">
    <div class="w-full px-6 py-8">
      <div class="animate-fade-in-up">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-sky-400 to-blue-400 bg-clip-text text-transparent mb-2">Request Item</h1>
        <p class="text-slate-400 text-sm">Send a request for this item and share your location for delivery or pickup.</p>
      </div>
    </div>
  </div>
  <div class="w-full px-6 py-12">
    <div class="max-w-2xl mx-auto">
      <div class="p-8 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-800/50 border border-slate-700 backdrop-blur-sm shadow-lg animate-fade-in-up mb-8">
        <h3 class="text-2xl font-semibold mb-2">{{ resource.title }}</h3>
        <div class="text-sm text-slate-400 mb-1">{{ resource.category }} ¬∑ {{ resource.quantity or 'Quantity not specified' }}</div>
        {% if resource.description %}
        <p class="mt-2 text-sm text-slate-300">{{ resource.description }}</p>
        {% endif %}
        <div class="mt-2 text-xs text-slate-400">Shared by {{ resource.user.name if resource.user else 'Unknown' }}</div>
        {% if resource.user.email %}
        <div class="mt-1 text-xs text-slate-400">Contact: {{ resource.user.email }}</div>
        {% endif %}
      </div>
      <form method="post" class="space-y-6 animate-fade-in-up">
        <div>
          <label class="block text-sm font-semibold text-slate-200 mb-2">Message to owner <span class="text-red-400">*</span></label>
          <textarea name="message" rows="4" class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-400 bg-slate-800 border border-slate-700" placeholder="Tell the owner why you need this item..." required></textarea>
        </div>
        <!-- Map Location -->
        <input type="hidden" name="latitude" id="requester-lat">
        <input type="hidden" name="longitude" id="requester-lng">
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-semibold text-slate-200">Pin your location on map <span class="text-red-400">*</span></label>
            <button type="button"
                    onclick="useMyLocationForRequester()"
                    class="text-xs px-3 py-1.5 rounded-full border border-sky-400/60 text-sky-300 hover:bg-sky-500/10 transition">
              üìç Use my current location
            </button>
          </div>
          <div id="requester-map" class="w-full h-64 rounded-xl border border-slate-700 overflow-hidden"></div>
          <p class="text-xs text-slate-400 mt-2">Share your location so the owner knows where to deliver or meet.</p>
        </div>
        <div class="flex items-center gap-3 pt-4">
          <button type="submit" class="btn-hover flex-1 px-6 py-3 rounded-lg bg-gradient-to-r from-sky-500 to-blue-600 text-slate-900 font-semibold shadow-lg hover:shadow-sky-500/50 transition flex items-center justify-center gap-2">Send Request</button>
          <a href="{{ url_for('resources.list_resources') }}" class="btn-hover px-6 py-3 rounded-lg bg-slate-700 text-white font-semibold hover:bg-slate-600 transition">Cancel</a>
          {% if resource.user.id != session.get('user_id') %}
          <a href="{{ url_for('chat_with_user', other_user_id=resource.user.id) }}" class="btn-hover px-6 py-3 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold shadow-lg hover:shadow-purple-500/50 transition">Contact Owner</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let requesterMap, requesterMarker;

  function initRequesterMap() {
    const defaultPos = { lat: 23.7806, lng: 90.4250 }; // Default to Dhaka

    requesterMap = new google.maps.Map(document.getElementById("requester-map"), {
      center: defaultPos,
      zoom: 15,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });

    requesterMap.addListener("click", (e) => {
      setRequesterMarker(e.latLng);
    });
  }

  function setRequesterMarker(latLng) {
    if (requesterMarker) {
      requesterMarker.setMap(null);
    }
    requesterMarker = new google.maps.Marker({
      position: latLng,
      map: requesterMap,
    });

    document.getElementById("requester-lat").value = latLng.lat().toFixed(6);
    document.getElementById("requester-lng").value = latLng.lng().toFixed(6);
  }

  function useMyLocationForRequester() {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser.");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const p = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
        };
        requesterMap.setCenter(p);
        requesterMap.setZoom(17);
        setRequesterMarker(p);
      },
      () => {
        alert("Could not get your location.");
      }
    );
  }

  // Block submit if map location not set
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    form.addEventListener("submit", (e) => {
      const lat = document.getElementById("requester-lat").value;
      const lng = document.getElementById("requester-lng").value;
      if (!lat || !lng) {
        e.preventDefault();
        alert("Please pin your location on the map before sending the request.");
      }
    });
  });
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initRequesterMap">
</script>
{% endblock %}
