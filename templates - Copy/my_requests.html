{% extends 'base.html' %}

{% block title %}My Requests - LifeLine{% endblock %}

{% block content %}
<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  .animate-slide-in-down {
    animation: slideInDown 0.6s ease-out forwards;
  }

  .card-item {
    animation: fadeInUp 0.6s ease-out backwards;
  }

  .card-item:nth-child(1) { animation-delay: 0.1s; }
  .card-item:nth-child(2) { animation-delay: 0.2s; }
  .card-item:nth-child(3) { animation-delay: 0.3s; }
  .card-item:nth-child(n+4) { animation-delay: 0.4s; }

  .card-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-hover:hover {
    transform: translateY(-4px);
    border-color: rgba(100, 200, 255, 0.5);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
  }

  .btn-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .btn-hover:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
  }
</style>

<div class="min-h-screen w-full bg-slate-950">
  <!-- Header Section -->
  <div class="bg-slate-950 border-b border-slate-800 shadow-lg">
    <div class="w-full px-6 py-8">
      <div class="animate-slide-in-down">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
          My Requests & Wanted Items
        </h1>
        <p class="text-slate-400 text-sm mt-2">Track your item requests and wanted posts</p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="w-full px-6 py-12">
    <div class="max-w-5xl mx-auto space-y-12">
      <!-- Item Requests Section -->
      <div>
        <div class="mb-6 flex items-center gap-3">
          <h2 class="text-2xl font-bold text-slate-100">My Item Requests</h2>
          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-900/50 text-purple-200 border border-purple-600/50">{{ requests|length if requests else 0 }}</span>
        </div>

        {% if not requests %}
        <div class="text-center py-16 animate-fade-in-up">
          <svg class="w-16 h-16 mx-auto mb-4 opacity-40 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <p class="text-slate-400 text-lg font-medium">You haven't made any requests yet</p>
          <p class="text-slate-500 text-sm mt-2">Browse items and request what you need</p>
          <a href="{{ url_for('resources.list_resources') }}" class="btn-hover inline-block mt-6 px-6 py-3 rounded-lg bg-gradient-to-r from-sky-500 to-blue-600 text-slate-900 font-semibold shadow-lg hover:shadow-sky-500/50">
            Browse Items
          </a>
        </div>
        {% else %}
          <div class="space-y-4">
            {% for req in requests %}
            <div class="card-item p-6 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-800/50 border border-slate-700 backdrop-blur-sm shadow-lg card-hover">
              <div class="flex gap-4">
                {% if req.resource.image_url %}
                <img src="{{ req.resource.image_url }}" alt="{{ req.resource.title }}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0">
                {% endif %}
                
                <div class="flex-1">
                  <div class="flex items-start justify-between gap-4 mb-3">
                    <div>
                      <h3 class="text-lg font-bold text-white">{{ req.resource.title }}</h3>
                      <div class="flex items-center gap-2 mt-1">
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-900/50 text-blue-200 border border-blue-600/50">{{ req.resource.category }}</span>
                        <span class="text-xs text-slate-400">{{ req.resource.quantity or 'Qty: N/A' }}</span>
                      </div>
                      <div class="mt-1 text-xs text-slate-400">Shared by: <span class="font-semibold text-slate-300">{{ req.resource.user.name if req.resource.user else 'Unknown' }}</span></div>
                    </div>
                    <!-- Status badge -->
                    {% if req.status == 'pending' %}
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-amber-900/50 text-amber-200 border border-amber-600/50">Pending</span>
                    {% elif req.status == 'accepted' %}
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-green-900/50 text-green-200 border border-green-600/50">Accepted</span>
                    {% elif req.status == 'rejected' %}
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-red-900/50 text-red-200 border border-red-600/50">Rejected</span>
                    {% endif %}
                  </div>
                  
                  {% if req.message %}
                  <div class="my-3 p-3 rounded-lg bg-slate-900/50 border-l-2 border-sky-500">
                    <p class="text-sm text-slate-300">{{ req.message }}</p>
                  </div>
                  {% endif %}

                  <div class="text-xs text-slate-500 mb-3">
                    Requested: {{ req.created_at.strftime('%b %d, %Y at %I:%M %p') if req.created_at else 'Date unknown' }}
                  </div>

                  <!-- Action buttons -->
                  <div class="flex gap-2 items-center flex-wrap">
                    {% if req.status == 'accepted' and req.resource.user %}
                    <a href="{{ url_for('chat_with_user', other_user_id=req.resource.user.id) }}" class="btn-hover px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm font-semibold hover:from-purple-500 hover:to-pink-500 transition">Chat with Owner</a>
                    {% endif %}
                    
                    <form method="post" action="{{ url_for('resources.delete_request', request_id=req.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this request?');">
                      <button type="submit" class="text-slate-400 hover:text-red-400 transition hover:scale-110 p-2" title="Delete request">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- My Wanted Items Section -->
      <div>
        <div class="mb-6 flex items-center gap-3">
          <h2 class="text-2xl font-bold text-slate-100">My Wanted Items</h2>
          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-amber-900/50 text-amber-200 border border-amber-600/50">{{ wanted_items|length if wanted_items else 0 }}</span>
        </div>
        
        {% if not wanted_items %}
        <div class="text-center py-16 animate-fade-in-up">
          <svg class="w-16 h-16 mx-auto mb-4 opacity-40 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <p class="text-slate-400 text-lg font-medium">You haven't posted any wanted items yet</p>
          <p class="text-slate-500 text-sm mt-2">Let neighbors know what you're looking for</p>
          <a href="{{ url_for('resources.list_resources') }}" class="btn-hover inline-block mt-6 px-6 py-3 rounded-lg bg-gradient-to-r from-amber-500 to-orange-600 text-slate-900 font-semibold shadow-lg hover:shadow-amber-500/50">
            Request an Item
          </a>
        </div>
        {% else %}
          <div class="space-y-4">
            {% for entry in wanted_items %}
            <div class="card-item p-6 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-800/50 border border-slate-700 backdrop-blur-sm shadow-lg card-hover">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 flex-wrap mb-3">
                    <h3 class="text-lg font-bold text-white">{{ entry.item.title }}</h3>
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-amber-900/50 text-amber-200 border border-amber-600/50">{{ entry.item.category }}</span>
                    
                    {% if entry.item.status == 'open' %}
                      {% if entry.days_left is not none %}
                        {% if entry.days_left <= 3 %}
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-red-900/50 text-red-200 border border-red-600/50 animate-pulse">{{ entry.days_left }} day{{ 's' if entry.days_left != 1 else '' }} left</span>
                        {% elif entry.days_left <= 7 %}
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-amber-900/50 text-amber-200 border border-amber-600/50">{{ entry.days_left }} days left</span>
                        {% else %}
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-emerald-900/50 text-emerald-200 border border-emerald-600/50">{{ entry.days_left }} days left</span>
                        {% endif %}
                      {% endif %}
                    {% else %}
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-slate-600/50 text-slate-300 border border-slate-500/50">Closed</span>
                    {% endif %}
                  </div>
                  
                  {% if entry.item.description %}
                  <p class="text-sm text-slate-300 mb-3 leading-relaxed">{{ entry.item.description }}</p>
                  {% endif %}

                  <div class="text-xs text-slate-500">
                    Posted: {{ entry.item.created_at.strftime('%b %d, %Y at %I:%M %p') if entry.item.created_at else 'Date unknown' }}
                  </div>
                </div>

                <div class="flex gap-2 items-start flex-wrap justify-end">
                  {% if entry.item.image_url %}
                  <button onclick="openImagePreview('{{ entry.item.image_url }}', '{{ entry.item.title }}')" class="btn-hover px-4 py-2 rounded-lg bg-slate-700 text-white text-sm font-semibold hover:bg-slate-600 transition">View Picture</button>
                  {% endif %}
                  
                  <form method="post" action="{{ url_for('resources.delete_wanted_item', wanted_id=entry.item.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this wanted item?');">
                    <button type="submit" class="text-slate-400 hover:text-red-400 transition hover:scale-110 p-2" title="Delete wanted item">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden flex items-center justify-center z-50 p-4 opacity-0 transition-opacity duration-300" onclick="closeImagePreview()">
  <div class="relative bg-gradient-to-br from-slate-900 to-slate-950 rounded-2xl shadow-2xl max-w-4xl max-h-[85vh] overflow-auto border border-slate-700" onclick="event.stopPropagation()">
    <button onclick="closeImagePreview()" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/80 backdrop-blur-sm p-2 rounded-lg hover:bg-slate-700 transition z-10">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <img id="previewImage" src="" alt="" class="w-full h-auto rounded-2xl">
    <p id="previewTitle" class="text-center text-white mt-4 mb-4 text-lg font-semibold px-4"></p>
  </div>
</div>

<script>
  function openImagePreview(imageUrl, title) {
    const modal = document.getElementById('imagePreviewModal');
    document.getElementById('previewImage').src = imageUrl;
    document.getElementById('previewTitle').textContent = title;
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.remove('opacity-0'), 50);
  }

  function closeImagePreview() {
    const modal = document.getElementById('imagePreviewModal');
    modal.classList.add('opacity-0');
    setTimeout(() => modal.classList.add('hidden'), 300);
  }
</script>
{% endblock %}
